const Users = require('../models/users');
const jwt = require('./jwt');

// authentication Middleware
async function authenticationMiddleware(req, res, next) {
  const authHeader = req.headers.authorization 
  try {
    if (authHeader) {
      const token = authHeader.split(' ')[1]
      const payload = jwt.verifyJwt(token)
      const user = await Users.findOne({_id: payload.id}, 'name emailId address').lean()
      user.id = payload.id
      req.user = user
    }
    next () 
  }
  catch(err) {
    console.log('error during Authentication of token')
    next(err)
  }
};



// Error handling middleware:
function errorHandlersMiddlerware(err, req, res, next) {
  console.log(err)
  res.json({ 'message': err.message, 'stack': err.stack })
}

module.exports = {
  errorHandlersMiddlerware,
  authenticationMiddleware
};   